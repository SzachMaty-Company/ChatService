<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <!--    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>-->
    <script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@5.0.0/bundles/stomp.umd.min.js"></script>
    <!--    <script src="Stomp.js"></script>-->
    <script defer>
        let client = null;
        let subscription = null;
        let messages = [];

        function displayMessages(messages) {
            let ul = [];
            for (const m of messages) {
                const li = document.createElement("li");

                li.innerHTML = `<p><span>chat: ${m.chatId} sender: ${m.senderId}: </span>${m.message}</p>`
                ul.push(li);
            }
            document.querySelector("#messages")
                .replaceChildren(...ul);
        }

        function callback(message) {
            messages.push(JSON.parse(message.body));
            displayMessages(messages);
        }

        function debugCallback(str) {
            console.debug(str)
        }

        async function connect() {
            client = new StompJs.Client({
                brokerURL: "ws://localhost:8124/registerws",
                debug: debugCallback,
                connectHeaders: {
                    token: document.getElementById("jwt").value
                }
            })

            // const userId = document.getElementById("user-id").value;
            // const chatId = document.getElementById("chat-id").value;

            // client.onConnect = function (frame) {
            //     const url = `/user/${userId}/messages`
            //     subscription = client.subscribe(url, callback);
            //     console.log({ subscription })
            //     console.log("subscribed to", url);
            // }
            console.log("client activated");
            client.activate();

            // console.log("client connected");

            // let response;
            // try {
            //     response = await fetch(`http://localhost:8124/chat/${chatId}/messages`, {
            //         method: "GET"
            //     });
            //     const data = await response.json();
            //     messages = data.content;
            //     // console.log(data.content[0])
            //     // .map(m => m.message)
            //     displayMessages(messages)
            // } catch (e) {
            //     console.error(e);
            // } finally {
            //     console.log("messages fetched with status:", response.status);
            // }
        }

        function auth() {
            const jwt = document.getElementById("jwt").value
            let credentials = { jwt };

            let results = client.publish({
                destination: "/chat/authentication",
                body: JSON.stringify(credentials),
                headers: { "Content-Type:": "application/json" }
            });

            console.log("results: ", results);
        }

        function disconnect() {
            if (client) {
                console.log("client deactivated")
                client.deactivate();
            }

            if (subscription) {
                console.log("unsubscribing")
                subscription.unsubscribe();
            }
        }

        async function sendMessage() {
            const chatId = document.getElementById("chat-id").value;
            const userId = document.getElementById("user-id").value;

            const message = document.getElementById("message-input").value;
            let response;

            try {
                response = await fetch(`http://localhost:8124/chat/${chatId}/sender/${userId}`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({message})
                })

            } catch (e) {
                console.error(e);
            } finally {
                console.log("message send status:", response.status)
            }
        }

        async function testCors() {
            try {
                const response = await fetch("http://localhost:8124/test", {
                    method: "GET",
                })

                console.log(response)
                const json = await response.json();
                console.log(json);
            } catch (e) {
                console.log(e);
            }
        }
    </script>
</head>
<body>

<div class="wrapper">
    <div>
        <div class="connection-wrapper">
<!--            <label for="chat-id">-->
<!--                chat id-->
<!--                <input type="text" id="chat-id" placeholder="chat id..."/>-->
<!--            </label>-->
<!--            <label for="user-id">-->
<!--                user id-->
<!--                <input type="text" id="user-id" placeholder="user id..."/>-->
<!--            </label>-->

            <label>
                jwt
                <input type="text" id="jwt" placeholder="jwt..."/>
            </label>
        </div>
        <button id="connect_btn" onclick="connect()">Connect</button>
        <button id="disconnect_btn" onclick="disconnect()">Disconnect</button>
        <button id="" onclick="auth()">Auth</button>
    </div>

    <!--    <button id="sub_btn" onclick="subscribe()">Subscribe</button>-->
<!--    <div>-->
<!--        <input type="text" id="from" placeholder="Choose a nickname"/>-->
<!--    </div>-->

<!--    <button onclick="displayMessages([])">test messages</button>-->
<!--    <label>-->
<!--        message-->
<!--        <input type="text" id="message-input" placeholder="message..."/>-->
<!--        <button id="send_btn" onclick="sendMessage()">Send</button>-->
<!--    </label>-->


<!--    <button id="test_cors" onclick="testCors()">Click to test cors</button>-->
</div>

<div>
    <h1>messages</h1>
    <ul id="messages"></ul>
</div>

</body>
<style>
    * {
        font-family: sans-serif;
        box-sizing: border-box;
    }

    .wrapper {
        display: flex;
        flex-direction: column;
        gap: 1ch;
    }

    .connection-wrapper {
        display: flex;
        flex-direction: column;
    }

    .connection-wrapper > * {
        width: fit-content;
    }

</style>
</html>
